
{% extends "layout.html" %}

{% block content %}
<div class="container mt-4">
    <div class="mb-4">
        <h2>Calculadora de Tiempos</h2>
        <div class="form-group mb-3">
            <label for="projectSelector" class="form-label">Seleccionar Proyecto</label>
            <select class="form-control" id="projectSelector" onchange="updateProjectData()">
                <option value="">Seleccione un proyecto...</option>
                {% for proyecto in proyectos %}
                <option value="{{ proyecto.id }}">{{ proyecto.nombre }}</option>
                {% endfor %}
            </select>
        </div>
    </div>
    <div class="d-flex justify-content-between align-items-center mb-4">
        <div id="selectedProjectName" class="h4"></div>
        <button class="btn btn-primary" onclick="openEntregableForm()">
            <i data-feather="plus"></i> Nuevo Entregable
        </button>
    </div>

    <!-- Popup Form for Entregable -->
    <div id="entregableFormPopup" class="modal">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Nuevo Entregable</h5>
                    <button type="button" class="btn-close" onclick="closeEntregableForm()" aria-label="Close">
                        <span aria-hidden="true">&times;</span>
                    </button>
                </div>
                <div class="modal-body">
                    <form id="entregableForm" onsubmit="addEntregable(event)">
                        <div class="mb-3">
                            <label for="entregableName" class="form-label">Nombre del Entregable</label>
                            <input type="text" class="form-control" id="entregableName" required>
                        </div>
                        <div class="d-flex gap-2">
                            <button type="submit" class="btn btn-primary">Guardar</button>
                            <button type="button" class="btn btn-secondary" onclick="closeEntregableForm()">Cancelar</button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>

    <!-- Popup Form for Actividad -->
    <div id="actividadFormPopup" class="modal">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Nueva Actividad</h5>
                    <button type="button" class="btn-close" onclick="closeActividadForm()" aria-label="Close">
                        <span aria-hidden="true">&times;</span>
                    </button>
                </div>
                <div class="modal-body">
                    <form id="actividadForm" onsubmit="addActividad(event)">
                        <input type="hidden" id="actividadEntregableId">
                        <div class="mb-3">
                            <label for="actividadName" class="form-label">Nombre de la Actividad</label>
                            <input type="text" class="form-control" id="actividadName" required>
                        </div>
                        <div class="d-flex gap-2">
                            <button type="submit" class="btn btn-primary">Guardar</button>
                            <button type="button" class="btn btn-secondary" onclick="closeActividadForm()">Cancelar</button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>

    <!-- Popup Form for Tarea -->
    <div id="tareaFormPopup" class="modal">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Nueva Tarea</h5>
                    <button type="button" class="btn-close" onclick="closeTareaForm()" aria-label="Close">
                        <span aria-hidden="true">&times;</span>
                    </button>
                </div>
                <div class="modal-body">
                    <form id="tareaForm" onsubmit="addTarea(event)">
                        <input type="hidden" id="tareaActividadId">
                        <div class="mb-3">
                            <label for="tareaName" class="form-label">Nombre de la Tarea</label>
                            <input type="text" class="form-control" id="tareaName" required>
                        </div>
                        <div class="mb-3">
                            <label for="optimisticTime" class="form-label">Tiempo Optimista (horas)</label>
                            <input type="number" class="form-control" id="optimisticTime" min="0" step="0.5" required>
                        </div>
                        <div class="mb-3">
                            <label for="mostLikelyTime" class="form-label">Tiempo Más Probable (horas)</label>
                            <input type="number" class="form-control" id="mostLikelyTime" min="0" step="0.5" required>
                        </div>
                        <div class="mb-3">
                            <label for="pessimisticTime" class="form-label">Tiempo Pesimista (horas)</label>
                            <input type="number" class="form-control" id="pessimisticTime" min="0" step="0.5" required>
                        </div>
                        <div class="d-flex gap-2">
                            <button type="submit" class="btn btn-primary">Guardar</button>
                            <button type="button" class="btn btn-secondary" onclick="closeTareaForm()">Cancelar</button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>

    <!-- Project Structure -->
    <div id="projectStructure">
        <!-- Entregables will be added here dynamically -->
    </div>

    <!-- Project Totals -->
    <div class="card mt-4">
        <div class="card-body">
            <h5>Totales del Proyecto</h5>
            <div class="row">
                <div class="col-md-3">
                    <p>Tiempo Optimista: <span id="projectOptimistic">0</span> horas</p>
                </div>
                <div class="col-md-3">
                    <p>Tiempo Más Probable: <span id="projectMostLikely">0</span> horas</p>
                </div>
                <div class="col-md-3">
                    <p>Tiempo Pesimista: <span id="projectPessimistic">0</span> horas</p>
                </div>
                <div class="col-md-3">
                    <p>Tiempo Estimado: <span id="projectEstimated">0</span> horas</p>
                </div>
            </div>
        </div>
    </div>

    <!-- Resource Costs -->
    <div class="card mt-4">
        <div class="card-body">
            <div class="d-flex justify-content-between align-items-center mb-3">
                <h5>Costos de Recursos Adicionales</h5>
                <button class="btn btn-primary" onclick="openResourceForm()">
                    <i data-feather="plus"></i> Nuevo Recurso
                </button>
            </div>
            <div class="table-responsive">
                <table class="table table-sm">
                    <thead>
                        <tr>
                            <th>Tipo de Recurso</th>
                            <th>Periodicidad</th>
                            <th>Moneda</th>
                            <th>Cantidad</th>
                            <th>Costo Unitario</th>
                            <th>Total</th>
                            <th>Total Anualizado</th>
                        </tr>
                    </thead>
                    <tbody id="resourcesTable">
                    </tbody>
                    <tfoot>
                        <tr class="table-info">
                            <td colspan="4"><strong>Total Recursos</strong></td>
                            <td id="totalResources"><strong>0</strong></td>
                        </tr>
                    </tfoot>
                </table>
            </div>
        </div>
    </div>

    <!-- Resource Form Popup -->
    <div id="resourceFormPopup" class="modal">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Nuevo Recurso</h5>
                    <button type="button" class="btn-close" onclick="closeResourceForm()" aria-label="Close">
                        <span aria-hidden="true">&times;</span>
                    </button>
                </div>
                <div class="modal-body">
                    <form id="resourceForm" onsubmit="addResource(event)">
                        <div class="mb-3">
                            <label for="resourceType" class="form-label">Tipo de Recurso</label>
                            <select class="form-control" id="resourceType" required>
                                <option value="">Seleccione...</option>
                                <option value="Software/licencias">Software/licencias</option>
                                <option value="Equipos">Equipos</option>
                                <option value="Capacitación externa">Capacitación externa</option>
                                <option value="Gastos operativos">Gastos operativos</option>
                            </select>
                        </div>
                        <div class="mb-3">
                            <label for="periodicity" class="form-label">Periodicidad</label>
                            <select class="form-control" id="periodicity" required>
                                <option value="">Seleccione...</option>
                                <option value="anual">Anual</option>
                                <option value="mensual">Mensual</option>
                                <option value="por uso">Por uso/consumo</option>
                            </select>
                        </div>
                        <div class="mb-3">
                            <label for="currency" class="form-label">Moneda</label>
                            <select class="form-control" id="currency" required>
                                <option value="">Seleccione...</option>
                                <option value="USD">Dólar (USD)</option>
                                <option value="EUR">Euro (EUR)</option>
                                <option value="COP">Peso Colombiano (COP)</option>
                                <option value="MXN">Peso Mexicano (MXN)</option>
                            </select>
                        </div>
                        <div class="mb-3">
                            <label for="quantity" class="form-label">Cantidad</label>
                            <input type="number" class="form-control" id="quantity" min="1" value="1" required>
                        </div>
                        <div class="mb-3">
                            <label for="cost" class="form-label">Costo Unitario</label>
                            <input type="number" class="form-control" id="cost" min="0" step="0.01" required>
                        </div>
                        <div class="d-flex gap-2">
                            <button type="submit" class="btn btn-primary">Guardar</button>
                            <button type="button" class="btn btn-secondary" onclick="closeResourceForm()">Cancelar</button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>

    <!-- Summary Report -->
    <div class="card mt-4 mb-4">
        <div class="card-body">
            <h5>Resumen de Estimación</h5>
            <div class="table-responsive">
                <table class="table table-sm">
                    <thead>
                        <tr>
                            <th>Nivel</th>
                            <th>Cantidad</th>
                            <th>Tiempo Total Estimado</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr>
                            <td>Entregables</td>
                            <td id="summaryEntregables">0</td>
                            <td id="summaryEntregablesTime">0 horas</td>
                        </tr>
                        <tr>
                            <td>Actividades</td>
                            <td id="summaryActividades">0</td>
                            <td id="summaryActividadesTime">0 horas</td>
                        </tr>
                        <tr>
                            <td>Tareas</td>
                            <td id="summaryTareas">0</td>
                            <td id="summaryTareasTime">0 horas</td>
                        </tr>
                        <tr class="table-info">
                            <td><strong>Total del Proyecto</strong></td>
                            <td>-</td>
                            <td id="summaryTotalTime"><strong>0 horas</strong></td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>
    </div>
</div>

<style>
.modal {
    display: none;
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background-color: rgba(0,0,0,0.5);
    z-index: 1000;
}

.modal.show {
    display: block;
}

.modal-dialog {
    margin: 30px auto;
    max-width: 500px;
}

.modal-content {
    background-color: white;
    padding: 20px;
    border-radius: 5px;
}

.entregable-card {
    margin-bottom: 1rem;
    border: 1px solid #dee2e6;
    border-radius: 0.25rem;
}

.actividad-card {
    margin: 0.5rem;
    border: 1px solid #e9ecef;
    border-radius: 0.25rem;
}

.tarea-row {
    padding: 0.5rem;
    margin: 0.5rem;
    background-color: #f8f9fa;
    border-radius: 0.25rem;
}

.tarea-times {
    display: flex;
    gap: 1rem;
    margin-top: 0.5rem;
}

.time-item {
    padding: 0.25rem 0.5rem;
    border: 1px solid #dee2e6;
    border-radius: 0.25rem;
    background-color: white;
}

.totals-row {
    margin-top: 1rem;
    padding: 1rem;
}

.actividad-totals, .entregable-totals {
    background-color: #f8f9fa;
    border: 1px solid #dee2e6;
    border-radius: 0.25rem;
    margin-top: 1rem;
}

.time-items {
    display: flex;
    gap: 0.5rem;
    margin-top: 0.5rem;
    flex-wrap: wrap;
}

.add-button {
    padding: 0.25rem 0.5rem;
    font-size: 0.875rem;
}
</style>

<script>
let projectData = {
    projectId: null,
    projectName: '',
    entregables: [],
    resources: []
};

function updateProjectData() {
    const selector = document.getElementById('projectSelector');
    const projectNameElem = document.getElementById('selectedProjectName');
    
    projectData.projectId = selector.value;
    projectData.projectName = selector.options[selector.selectedIndex].text;
    
    if (projectData.projectId) {
        projectNameElem.textContent = projectData.projectName;
        document.getElementById('projectStructure').style.display = 'block';
    } else {
        projectNameElem.textContent = '';
        document.getElementById('projectStructure').style.display = 'none';
    }
}

// Entregable Functions
function openEntregableForm() {
    document.getElementById('entregableFormPopup').classList.add('show');
}

function closeEntregableForm() {
    document.getElementById('entregableFormPopup').classList.remove('show');
    document.getElementById('entregableForm').reset();
}

function addEntregable(event) {
    event.preventDefault();
    const entregable = {
        id: Date.now(),
        name: document.getElementById('entregableName').value,
        actividades: []
    };
    projectData.entregables.push(entregable);
    renderProject();
    closeEntregableForm();
}

// Actividad Functions
function openActividadForm(entregableId) {
    document.getElementById('actividadEntregableId').value = entregableId;
    document.getElementById('actividadFormPopup').classList.add('show');
}

function closeActividadForm() {
    document.getElementById('actividadFormPopup').classList.remove('show');
    document.getElementById('actividadForm').reset();
}

function addActividad(event) {
    event.preventDefault();
    const entregableId = parseInt(document.getElementById('actividadEntregableId').value);
    const actividad = {
        id: Date.now(),
        name: document.getElementById('actividadName').value,
        tareas: []
    };
    
    const entregable = projectData.entregables.find(e => e.id === entregableId);
    if (entregable) {
        entregable.actividades.push(actividad);
        renderProject();
    }
    closeActividadForm();
}

// Tarea Functions
function openTareaForm(actividadId) {
    document.getElementById('tareaActividadId').value = actividadId;
    document.getElementById('tareaFormPopup').classList.add('show');
}

function closeTareaForm() {
    document.getElementById('tareaFormPopup').classList.remove('show');
    document.getElementById('tareaForm').reset();
}

function addTarea(event) {
    event.preventDefault();
    const actividadId = parseInt(document.getElementById('tareaActividadId').value);
    const tarea = {
        id: Date.now(),
        name: document.getElementById('tareaName').value,
        optimistic: parseFloat(document.getElementById('optimisticTime').value),
        mostLikely: parseFloat(document.getElementById('mostLikelyTime').value),
        pessimistic: parseFloat(document.getElementById('pessimisticTime').value)
    };
    
    for (let entregable of projectData.entregables) {
        const actividad = entregable.actividades.find(a => a.id === actividadId);
        if (actividad) {
            actividad.tareas.push(tarea);
            renderProject();
            break;
        }
    }
    closeTareaForm();
}

// Calculation Functions
function calculateTareaEstimated(tarea) {
    return (tarea.optimistic + (4 * tarea.mostLikely) + tarea.pessimistic) / 6;
}

function calculateActividadTotals(actividad) {
    return actividad.tareas.reduce((totals, tarea) => {
        totals.optimistic += tarea.optimistic;
        totals.mostLikely += tarea.mostLikely;
        totals.pessimistic += tarea.pessimistic;
        totals.estimated += calculateTareaEstimated(tarea);
        return totals;
    }, { optimistic: 0, mostLikely: 0, pessimistic: 0, estimated: 0 });
}

function calculateEntregableTotals(entregable) {
    return entregable.actividades.reduce((totals, actividad) => {
        const actividadTotals = calculateActividadTotals(actividad);
        totals.optimistic += actividadTotals.optimistic;
        totals.mostLikely += actividadTotals.mostLikely;
        totals.pessimistic += actividadTotals.pessimistic;
        totals.estimated += actividadTotals.estimated;
        return totals;
    }, { optimistic: 0, mostLikely: 0, pessimistic: 0, estimated: 0 });
}

function calculateProjectTotals() {
    return projectData.entregables.reduce((totals, entregable) => {
        const entregableTotals = calculateEntregableTotals(entregable);
        totals.optimistic += entregableTotals.optimistic;
        totals.mostLikely += entregableTotals.mostLikely;
        totals.pessimistic += entregableTotals.pessimistic;
        totals.estimated += entregableTotals.estimated;
        return totals;
    }, { optimistic: 0, mostLikely: 0, pessimistic: 0, estimated: 0 });
}

// Render Functions
// Resource Functions
function openResourceForm() {
    document.getElementById('resourceFormPopup').classList.add('show');
}

function closeResourceForm() {
    document.getElementById('resourceFormPopup').classList.remove('show');
    document.getElementById('resourceForm').reset();
}

function addResource(event) {
    event.preventDefault();
    const resource = {
        id: Date.now(),
        type: document.getElementById('resourceType').value,
        periodicity: document.getElementById('periodicity').value,
        currency: document.getElementById('currency').value,
        quantity: parseInt(document.getElementById('quantity').value),
        cost: parseFloat(document.getElementById('cost').value)
    };
    
    projectData.resources.push(resource);
    renderResources();
    closeResourceForm();
}

function calculateAnnualizedCost(resource) {
    let annualCost = resource.cost * resource.quantity;
    if (resource.periodicity === 'mensual') {
        annualCost *= 12;
    }
    return annualCost;
}

function renderResources() {
    const tbody = document.getElementById('resourcesTable');
    tbody.innerHTML = '';
    
    let totalAnnualCost = 0;
    
    projectData.resources.forEach(resource => {
        const annualizedCost = calculateAnnualizedCost(resource);
        totalAnnualCost += annualizedCost;
        
        const total = resource.cost * resource.quantity;
        const formatter = new Intl.NumberFormat('es-CO', {
            style: 'currency',
            currency: resource.currency,
            minimumFractionDigits: 2,
            maximumFractionDigits: 2
        });
        
        const row = `
            <tr>
                <td>${resource.type}</td>
                <td>${resource.periodicity}</td>
                <td>${resource.currency}</td>
                <td>${resource.quantity}</td>
                <td>${formatter.format(resource.cost)}</td>
                <td>${formatter.format(total)}</td>
                <td>${formatter.format(annualizedCost)}</td>
            </tr>
        `;
        tbody.insertAdjacentHTML('beforeend', row);
    });
    
    // Format total with the last used currency, or USD if no resources
    const defaultFormatter = new Intl.NumberFormat('es-CO', {
        style: 'currency',
        currency: projectData.resources.length > 0 ? projectData.resources[projectData.resources.length - 1].currency : 'USD',
        minimumFractionDigits: 2,
        maximumFractionDigits: 2
    });
    
    document.getElementById('totalResources').textContent = defaultFormatter.format(totalAnnualCost);
}

function updateSummary() {
    let totalEntregables = projectData.entregables.length;
    let totalActividades = 0;
    let totalTareas = 0;
    let totalTime = 0;
    
    projectData.entregables.forEach(entregable => {
        totalActividades += entregable.actividades.length;
        entregable.actividades.forEach(actividad => {
            totalTareas += actividad.tareas.length;
        });
    });

    const projectTotals = calculateProjectTotals();
    totalTime = projectTotals.estimated;

    document.getElementById('summaryEntregables').textContent = totalEntregables;
    document.getElementById('summaryActividades').textContent = totalActividades;
    document.getElementById('summaryTareas').textContent = totalTareas;
    document.getElementById('summaryEntregablesTime').textContent = projectTotals.estimated.toFixed(1) + ' horas';
    document.getElementById('summaryActividadesTime').textContent = projectTotals.estimated.toFixed(1) + ' horas';
    document.getElementById('summaryTareasTime').textContent = projectTotals.estimated.toFixed(1) + ' horas';
    document.getElementById('summaryTotalTime').textContent = totalTime.toFixed(1) + ' horas';
}

function renderProject() {
    const container = document.getElementById('projectStructure');
    container.innerHTML = '';
    
    projectData.entregables.forEach(entregable => {
        const entregableTotals = calculateEntregableTotals(entregable);
        const entregableHtml = `
            <div class="entregable-card">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <h5>${entregable.name}</h5>
                    <button class="btn btn-sm btn-primary add-button" onclick="openActividadForm(${entregable.id})">
                        <i data-feather="plus"></i> Actividad
                    </button>
                </div>
                <div class="card-body">
                    <div class="actividades-container">
                        ${renderActividades(entregable.actividades)}
                    </div>
                    <div class="totals-row entregable-totals">
                        <strong>Totales del Entregable:</strong>
                        <div class="time-items">
                            <span class="time-item">Optimista: ${entregableTotals.optimistic.toFixed(1)}h</span>
                            <span class="time-item">Más Probable: ${entregableTotals.mostLikely.toFixed(1)}h</span>
                            <span class="time-item">Pesimista: ${entregableTotals.pessimistic.toFixed(1)}h</span>
                            <span class="time-item">Estimado: ${entregableTotals.estimated.toFixed(1)}h</span>
                        </div>
                    </div>
                </div>
            </div>
        `;
        container.insertAdjacentHTML('beforeend', entregableHtml);
    });

    // Update project totals
    const projectTotals = calculateProjectTotals();
    document.getElementById('projectOptimistic').textContent = projectTotals.optimistic.toFixed(1);
    document.getElementById('projectMostLikely').textContent = projectTotals.mostLikely.toFixed(1);
    document.getElementById('projectPessimistic').textContent = projectTotals.pessimistic.toFixed(1);
    document.getElementById('projectEstimated').textContent = projectTotals.estimated.toFixed(1);

    // Re-initialize Feather icons
    if (window.feather) {
        feather.replace();
    }
    
    updateSummary();
}

function renderActividades(actividades) {
    return actividades.map(actividad => {
        const actividadTotals = calculateActividadTotals(actividad);
        return `
            <div class="actividad-card">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <h6>${actividad.name}</h6>
                    <button class="btn btn-sm btn-secondary add-button" onclick="openTareaForm(${actividad.id})">
                        <i data-feather="plus"></i> Tarea
                    </button>
                </div>
                <div class="card-body">
                    <div class="tareas-container">
                        ${renderTareas(actividad.tareas)}
                    </div>
                    <div class="totals-row actividad-totals">
                        <strong>Totales de la Actividad:</strong>
                        <div class="time-items">
                            <span class="time-item">Optimista: ${actividadTotals.optimistic.toFixed(1)}h</span>
                            <span class="time-item">Más Probable: ${actividadTotals.mostLikely.toFixed(1)}h</span>
                            <span class="time-item">Pesimista: ${actividadTotals.pessimistic.toFixed(1)}h</span>
                            <span class="time-item">Estimado: ${actividadTotals.estimated.toFixed(1)}h</span>
                        </div>
                    </div>
                </div>
            </div>
        `;
    }).join('');
}

function renderTareas(tareas) {
    return tareas.map(tarea => `
        <div class="tarea-row">
            <div class="d-flex justify-content-between align-items-center">
                <span>${tarea.name}</span>
                <div class="tarea-times">
                    <span class="time-item">Optimista: ${tarea.optimistic}h</span>
                    <span class="time-item">Más Probable: ${tarea.mostLikely}h</span>
                    <span class="time-item">Pesimista: ${tarea.pessimistic}h</span>
                    <span class="time-item">Estimado: ${calculateTareaEstimated(tarea).toFixed(1)}h</span>
                </div>
            </div>
        </div>
    `).join('');
}
</script>
{% endblock %}
