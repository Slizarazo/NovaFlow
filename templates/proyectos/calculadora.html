
{% extends "layout.html" %}

{% block content %}
<div class="container mt-4">
    <div class="mb-4">
        <h2>Calculadora de Tiempos</h2>
        <div class="form-group mb-3">
            <label for="projectSelector" class="form-label">Seleccionar Proyecto</label>
            <select class="form-control" id="projectSelector" onchange="updateProjectData()">
                <option value="">Seleccione un proyecto...</option>
                {% for proyecto in proyectos %}
                <option value="{{ proyecto.id }}">{{ proyecto.nombre }}</option>
                {% endfor %}
            </select>
        </div>
    </div>
    <div class="d-flex justify-content-between align-items-center mb-4">
        <div id="selectedProjectName" class="h4"></div>
        <button class="btn btn-primary" onclick="openEntregableForm()">
            <i data-feather="plus"></i> Nuevo Entregable
        </button>
    </div>

    <!-- Popup Form for Entregable -->
    <div id="entregableFormPopup" class="modal">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Nuevo Entregable</h5>
                    <button type="button" class="btn-close" onclick="closeEntregableForm()" aria-label="Close">
                        <span aria-hidden="true">&times;</span>
                    </button>
                </div>
                <div class="modal-body">
                    <form id="entregableForm" onsubmit="addEntregable(event)">
                        <div class="mb-3">
                            <label for="entregableName" class="form-label">Nombre del Entregable</label>
                            <input type="text" class="form-control" id="entregableName" required>
                        </div>
                        <div class="d-flex gap-2">
                            <button type="submit" class="btn btn-primary">Guardar</button>
                            <button type="button" class="btn btn-secondary" onclick="closeEntregableForm()">Cancelar</button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>

    <!-- Popup Form for Actividad -->
    <div id="actividadFormPopup" class="modal">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Nueva Actividad</h5>
                    <button type="button" class="btn-close" onclick="closeActividadForm()" aria-label="Close">
                        <span aria-hidden="true">&times;</span>
                    </button>
                </div>
                <div class="modal-body">
                    <form id="actividadForm" onsubmit="addActividad(event)">
                        <input type="hidden" id="actividadEntregableId">
                        <div class="mb-3">
                            <label for="actividadName" class="form-label">Nombre de la Actividad</label>
                            <input type="text" class="form-control" id="actividadName" required>
                        </div>
                        <div class="d-flex gap-2">
                            <button type="submit" class="btn btn-primary">Guardar</button>
                            <button type="button" class="btn btn-secondary" onclick="closeActividadForm()">Cancelar</button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>

    <!-- Popup Form for Tarea -->
    <div id="tareaFormPopup" class="modal">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Nueva Tarea</h5>
                    <button type="button" class="btn-close" onclick="closeTareaForm()" aria-label="Close">
                        <span aria-hidden="true">&times;</span>
                    </button>
                </div>
                <div class="modal-body">
                    <form id="tareaForm" onsubmit="addTarea(event)">
                        <input type="hidden" id="tareaActividadId">
                        <div class="mb-3">
                            <label for="tareaName" class="form-label">Nombre de la Tarea</label>
                            <input type="text" class="form-control" id="tareaName" required>
                        </div>
                        <div class="mb-3">
                            <label for="optimisticTime" class="form-label">Tiempo Optimista (horas)</label>
                            <input type="number" class="form-control" id="optimisticTime" min="0" step="0.5" required>
                        </div>
                        <div class="mb-3">
                            <label for="mostLikelyTime" class="form-label">Tiempo Más Probable (horas)</label>
                            <input type="number" class="form-control" id="mostLikelyTime" min="0" step="0.5" required>
                        </div>
                        <div class="mb-3">
                            <label for="pessimisticTime" class="form-label">Tiempo Pesimista (horas)</label>
                            <input type="number" class="form-control" id="pessimisticTime" min="0" step="0.5" required>
                        </div>
                        <div class="d-flex gap-2">
                            <button type="submit" class="btn btn-primary">Guardar</button>
                            <button type="button" class="btn btn-secondary" onclick="closeTareaForm()">Cancelar</button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>

    <!-- Project Structure -->
    <div id="projectStructure">
        <!-- Entregables will be added here dynamically -->
    </div>

    <!-- Project Totals -->
    <div class="card mt-4">
        <div class="card-body">
            <h5>Totales del Proyecto</h5>
            <div class="row">
                <div class="col-md-3">
                    <p>Tiempo Optimista: <span id="projectOptimistic">0</span> horas</p>
                </div>
                <div class="col-md-3">
                    <p>Tiempo Más Probable: <span id="projectMostLikely">0</span> horas</p>
                </div>
                <div class="col-md-3">
                    <p>Tiempo Pesimista: <span id="projectPessimistic">0</span> horas</p>
                </div>
                <div class="col-md-3">
                    <p>Tiempo Estimado: <span id="projectEstimated">0</span> horas</p>
                </div>
            </div>
        </div>
    </div>

    <!-- Resource Costs -->
    <div class="card mt-4">
        <div class="card-body">
            <div class="d-flex justify-content-between align-items-center mb-3">
                <h5>Costos de Recursos Adicionales</h5>
                <button class="btn btn-primary" onclick="openResourceForm()">
                    <i data-feather="plus"></i> Nuevo Recurso
                </button>
            </div>
            <div class="table-responsive">
                <table class="table table-sm">
                    <thead>
                        <tr>
                            <th>Tipo de Recurso</th>
                            <th>Periodicidad</th>
                            <th>Moneda</th>
                            <th>Cantidad</th>
                            <th>Costo Unitario</th>
                            <th>Total</th>
                            <th>Total Anualizado</th>
                        </tr>
                    </thead>
                    <tbody id="resourcesTable">
                    </tbody>
                    <tfoot>
                        <tr class="table-info">
                            <td colspan="4"><strong>Total Recursos</strong></td>
                            <td id="totalUnitCost"><strong>0</strong></td>
                            <td id="totalCost"><strong>0</strong></td>
                            <td id="totalAnnualCost"><strong>0</strong></td>
                        </tr>
                    </tfoot>
                </table>
            </div>
        </div>
    </div>

    <!-- Resource Form Popup -->
    <div id="resourceFormPopup" class="modal">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Nuevo Recurso</h5>
                    <button type="button" class="btn-close" onclick="closeResourceForm()" aria-label="Close">
                        <span aria-hidden="true">&times;</span>
                    </button>
                </div>
                <div class="modal-body">
                    <form id="resourceForm" onsubmit="addResource(event)">
                        <div class="mb-3">
                            <label for="resourceType" class="form-label">Tipo de Recurso</label>
                            <select class="form-control" id="resourceType" required>
                                <option value="">Seleccione...</option>
                                <option value="Software/licencias">Software/licencias</option>
                                <option value="Equipos">Equipos</option>
                                <option value="Capacitación externa">Capacitación externa</option>
                                <option value="Gastos operativos">Gastos operativos</option>
                            </select>
                        </div>
                        <div class="mb-3">
                            <label for="periodicity" class="form-label">Periodicidad</label>
                            <select class="form-control" id="periodicity" required>
                                <option value="">Seleccione...</option>
                                <option value="anual">Anual</option>
                                <option value="mensual">Mensual</option>
                                <option value="por uso">Por uso/consumo</option>
                            </select>
                        </div>
                        <div class="mb-3">
                            <label for="currency" class="form-label">Moneda</label>
                            <select class="form-control" id="currency" required>
                                <option value="">Seleccione...</option>
                                <option value="USD">Dólar (USD)</option>
                                <option value="EUR">Euro (EUR)</option>
                                <option value="COP">Peso Colombiano (COP)</option>
                                <option value="MXN">Peso Mexicano (MXN)</option>
                            </select>
                        </div>
                        <div class="mb-3">
                            <label for="quantity" class="form-label">Cantidad</label>
                            <input type="number" class="form-control" id="quantity" min="1" value="1" required>
                        </div>
                        <div class="mb-3">
                            <label for="cost" class="form-label">Costo Unitario</label>
                            <input type="number" class="form-control" id="cost" min="0" step="0.01" required>
                        </div>
                        <div class="d-flex gap-2">
                            <button type="submit" class="btn btn-primary">Guardar</button>
                            <button type="button" class="btn btn-secondary" onclick="closeResourceForm()">Cancelar</button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>

    <!-- Freelance Costs -->
    <div class="card mt-4">
        <div class="card-body">
            <div class="d-flex justify-content-between align-items-center mb-3">
                <h5>Costos de Freelance</h5>
                <button class="btn btn-primary" onclick="openFreelanceForm()">
                    <i data-feather="plus"></i> Nuevo Freelance
                </button>
            </div>
            <div class="table-responsive">
                <table class="table table-sm">
                    <thead>
                        <tr>
                            <th>Área de Especialidad</th>
                            <th>Nivel</th>
                            <th>Tarifa por Hora (USD)</th>
                            <th>Actividad</th>
                            <th>Horas Estimadas</th>
                            <th>Costo Total</th>
                        </tr>
                    </thead>
                    <tbody id="freelanceTable">
                    </tbody>
                    <tfoot>
                        <tr class="table-info">
                            <td colspan="5"><strong>Total Freelance</strong></td>
                            <td id="totalFreelanceCost"><strong>0</strong></td>
                        </tr>
                    </tfoot>
                </table>
            </div>
        </div>
    </div>

    <!-- Freelance Form Popup -->
    <div id="freelanceFormPopup" class="modal">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Nuevo Freelance</h5>
                    <button type="button" class="btn-close" onclick="closeFreelanceForm()" aria-label="Close">
                        <span aria-hidden="true">&times;</span>
                    </button>
                </div>
                <div class="modal-body">
                    <form id="freelanceForm" onsubmit="addFreelance(event)">
                        <div class="mb-3">
                            <label for="specialty" class="form-label">Área de Especialidad</label>
                            <select class="form-control" id="specialty" required>
                                <option value="">Seleccione...</option>
                                <option value="Analista de datos">Analista de datos</option>
                                <option value="Desarrollador">Desarrollador</option>
                                <option value="DevOps">DevOps</option>
                                <option value="Otros">Otros</option>
                            </select>
                        </div>
                        <div class="mb-3">
                            <label for="level" class="form-label">Nivel</label>
                            <select class="form-control" id="level" onchange="updateRate()" required>
                                <option value="">Seleccione...</option>
                                <option value="junior">Junior</option>
                                <option value="mid">Mid</option>
                                <option value="senior">Senior</option>
                            </select>
                        </div>
                        <div class="mb-3">
                            <label for="rate" class="form-label">Tarifa por Hora (USD)</label>
                            <input type="number" class="form-control" id="rate" required readonly>
                            <small class="form-text text-muted" id="rateRange"></small>
                        </div>
                        <div class="mb-3">
                            <label for="activity" class="form-label">Actividad</label>
                            <select class="form-control" id="freelanceActivity" required>
                                <option value="">Seleccione...</option>
                            </select>
                        </div>
                        <div class="d-flex gap-2">
                            <button type="submit" class="btn btn-primary">Guardar</button>
                            <button type="button" class="btn btn-secondary" onclick="closeFreelanceForm()">Cancelar</button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>

    <!-- Save Button -->
    <div class="text-center mb-4">
        <button class="btn btn-primary btn-lg" onclick="saveProjectData()">
            <i data-feather="save"></i> Guardar Estimación
        </button>
    </div>

    <!-- Summary Report -->
    <div class="card mt-4 mb-4">
        <div class="card-body">
            <h5>Resumen de Estimación</h5>
            <div class="table-responsive">
                <table class="table table-sm">
                    <thead>
                        <tr>
                            <th>Nivel</th>
                            <th>Cantidad</th>
                            <th>Tiempo Total Estimado</th>
                            <th>Costo Estimado</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr>
                            <td>Entregables</td>
                            <td id="summaryEntregables">0</td>
                            <td id="summaryEntregablesTime">0 horas</td>
                            <td>-</td>
                        </tr>
                        <tr>
                            <td>Actividades</td>
                            <td id="summaryActividades">0</td>
                            <td id="summaryActividadesTime">0 horas</td>
                            <td>-</td>
                        </tr>
                        <tr>
                            <td>Tareas</td>
                            <td id="summaryTareas">0</td>
                            <td id="summaryTareasTime">0 horas</td>
                            <td>-</td>
                        </tr>
                        <tr>
                            <td>Recursos Adicionales</td>
                            <td id="summaryResources">0</td>
                            <td>-</td>
                            <td id="summaryResourcesCost">$0</td>
                        </tr>
                        <tr>
                            <td>Freelance</td>
                            <td id="summaryFreelance">0</td>
                            <td>-</td>
                            <td id="summaryFreelanceCost">$0</td>
                        </tr>
                        <tr class="table-info">
                            <td><strong>Total del Proyecto</strong></td>
                            <td>-</td>
                            <td id="summaryTotalTime"><strong>0 horas</strong></td>
                            <td id="summaryTotalCost"><strong>$0</strong></td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>
    </div>
</div>

<style>
.modal {
    display: none;
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background-color: rgba(0,0,0,0.5);
    z-index: 1000;
}

.modal.show {
    display: block;
}

.modal-dialog {
    margin: 30px auto;
    max-width: 500px;
}

.modal-content {
    background-color: white;
    padding: 20px;
    border-radius: 5px;
}

.entregable-card {
    margin-bottom: 1rem;
    border: 1px solid #dee2e6;
    border-radius: 0.25rem;
}

.actividad-card {
    margin: 0.5rem;
    border: 1px solid #e9ecef;
    border-radius: 0.25rem;
}

.tarea-row {
    padding: 0.5rem;
    margin: 0.5rem;
    background-color: #f8f9fa;
    border-radius: 0.25rem;
}

.tarea-times {
    display: flex;
    gap: 1rem;
    margin-top: 0.5rem;
}

.time-item {
    padding: 0.25rem 0.5rem;
    border: 1px solid #dee2e6;
    border-radius: 0.25rem;
    background-color: white;
}

.totals-row {
    margin-top: 1rem;
    padding: 1rem;
}

.actividad-totals, .entregable-totals {
    background-color: #f8f9fa;
    border: 1px solid #dee2e6;
    border-radius: 0.25rem;
    margin-top: 1rem;
}

.time-items {
    display: flex;
    gap: 0.5rem;
    margin-top: 0.5rem;
    flex-wrap: wrap;
}

.add-button {
    padding: 0.25rem 0.5rem;
    font-size: 0.875rem;
}
</style>

<script>
let projectData = {
    projectId: null,
    projectName: '',
    entregables: [],
    resources: []
};

function updateProjectData() {
    const selector = document.getElementById('projectSelector');
    const projectNameElem = document.getElementById('selectedProjectName');
    
    projectData.projectId = selector.value;
    projectData.projectName = selector.options[selector.selectedIndex].text;
    
    if (projectData.projectId) {
        projectNameElem.textContent = projectData.projectName;
        document.getElementById('projectStructure').style.display = 'block';
    } else {
        projectNameElem.textContent = '';
        document.getElementById('projectStructure').style.display = 'none';
    }
}

// Entregable Functions
function openEntregableForm() {
    document.getElementById('entregableFormPopup').classList.add('show');
}

function closeEntregableForm() {
    document.getElementById('entregableFormPopup').classList.remove('show');
    document.getElementById('entregableForm').reset();
}

function addEntregable(event) {
    event.preventDefault();
    const entregable = {
        id: Date.now(),
        name: document.getElementById('entregableName').value,
        actividades: []
    };
    projectData.entregables.push(entregable);
    renderProject();
    closeEntregableForm();
}

// Actividad Functions
function openActividadForm(entregableId) {
    document.getElementById('actividadEntregableId').value = entregableId;
    document.getElementById('actividadFormPopup').classList.add('show');
}

function closeActividadForm() {
    document.getElementById('actividadFormPopup').classList.remove('show');
    document.getElementById('actividadForm').reset();
}

function addActividad(event) {
    event.preventDefault();
    const entregableId = parseInt(document.getElementById('actividadEntregableId').value);
    const actividad = {
        id: Date.now(),
        name: document.getElementById('actividadName').value,
        tareas: []
    };
    
    const entregable = projectData.entregables.find(e => e.id === entregableId);
    if (entregable) {
        entregable.actividades.push(actividad);
        renderProject();
    }
    closeActividadForm();
}

// Tarea Functions
function openTareaForm(actividadId) {
    document.getElementById('tareaActividadId').value = actividadId;
    document.getElementById('tareaFormPopup').classList.add('show');
}

function closeTareaForm() {
    document.getElementById('tareaFormPopup').classList.remove('show');
    document.getElementById('tareaForm').reset();
}

function addTarea(event) {
    event.preventDefault();
    const actividadId = parseInt(document.getElementById('tareaActividadId').value);
    const tarea = {
        id: Date.now(),
        name: document.getElementById('tareaName').value,
        optimistic: parseFloat(document.getElementById('optimisticTime').value),
        mostLikely: parseFloat(document.getElementById('mostLikelyTime').value),
        pessimistic: parseFloat(document.getElementById('pessimisticTime').value)
    };
    
    for (let entregable of projectData.entregables) {
        const actividad = entregable.actividades.find(a => a.id === actividadId);
        if (actividad) {
            actividad.tareas.push(tarea);
            renderProject();
            break;
        }
    }
    closeTareaForm();
}

// Calculation Functions
function calculateTareaEstimated(tarea) {
    return (tarea.optimistic + (4 * tarea.mostLikely) + tarea.pessimistic) / 6;
}

function calculateActividadTotals(actividad) {
    return actividad.tareas.reduce((totals, tarea) => {
        totals.optimistic += tarea.optimistic;
        totals.mostLikely += tarea.mostLikely;
        totals.pessimistic += tarea.pessimistic;
        totals.estimated += calculateTareaEstimated(tarea);
        return totals;
    }, { optimistic: 0, mostLikely: 0, pessimistic: 0, estimated: 0 });
}

function calculateEntregableTotals(entregable) {
    return entregable.actividades.reduce((totals, actividad) => {
        const actividadTotals = calculateActividadTotals(actividad);
        totals.optimistic += actividadTotals.optimistic;
        totals.mostLikely += actividadTotals.mostLikely;
        totals.pessimistic += actividadTotals.pessimistic;
        totals.estimated += actividadTotals.estimated;
        return totals;
    }, { optimistic: 0, mostLikely: 0, pessimistic: 0, estimated: 0 });
}

function calculateProjectTotals() {
    return projectData.entregables.reduce((totals, entregable) => {
        const entregableTotals = calculateEntregableTotals(entregable);
        totals.optimistic += entregableTotals.optimistic;
        totals.mostLikely += entregableTotals.mostLikely;
        totals.pessimistic += entregableTotals.pessimistic;
        totals.estimated += entregableTotals.estimated;
        return totals;
    }, { optimistic: 0, mostLikely: 0, pessimistic: 0, estimated: 0 });
}

// Render Functions
// Resource Functions
function openResourceForm() {
    document.getElementById('resourceFormPopup').classList.add('show');
}

function closeResourceForm() {
    document.getElementById('resourceFormPopup').classList.remove('show');
    document.getElementById('resourceForm').reset();
}

function addResource(event) {
    event.preventDefault();
    const resource = {
        id: Date.now(),
        type: document.getElementById('resourceType').value,
        periodicity: document.getElementById('periodicity').value,
        currency: document.getElementById('currency').value,
        quantity: parseInt(document.getElementById('quantity').value),
        cost: parseFloat(document.getElementById('cost').value)
    };
    
    projectData.resources.push(resource);
    renderResources();
    closeResourceForm();
}

function calculateAnnualizedCost(resource) {
    let annualCost = resource.cost * resource.quantity;
    if (resource.periodicity === 'mensual') {
        annualCost *= 12;
    }
    return annualCost;
}

// Definir tasas de conversión a COP
const exchangeRates = {
    'USD': 4000, // 1 USD = 4000 COP
    'EUR': 4300, // 1 EUR = 4300 COP
    'MXN': 235,  // 1 MXN = 235 COP
    'COP': 1     // 1 COP = 1 COP
};

function convertToCOP(amount, fromCurrency) {
    return amount * exchangeRates[fromCurrency];
}

function formatCurrency(amount, currency = 'COP') {
    return new Intl.NumberFormat('es-CO', {
        style: 'currency',
        currency: currency,
        minimumFractionDigits: 0,
        maximumFractionDigits: 0
    }).format(amount);
}

function renderResources() {
    const tbody = document.getElementById('resourcesTable');
    tbody.innerHTML = '';
    
    let totalUnitCostCOP = 0;
    let totalDirectCostCOP = 0;
    let totalAnnualCostCOP = 0;
    
    projectData.resources.forEach(resource => {
        const costInCOP = convertToCOP(resource.cost, resource.currency);
        const totalInCOP = costInCOP * resource.quantity;
        const annualizedCostInCOP = calculateAnnualizedCost({...resource, cost: costInCOP});
        
        totalUnitCostCOP += costInCOP;
        totalDirectCostCOP += totalInCOP;
        totalAnnualCostCOP += annualizedCostInCOP;
        
        const row = `
            <tr>
                <td>${resource.type}</td>
                <td>${resource.periodicity}</td>
                <td>${resource.currency}</td>
                <td>${resource.quantity}</td>
                <td>${formatCurrency(costInCOP)} <small class="text-muted">(${formatCurrency(resource.cost, resource.currency)})</small></td>
                <td>${formatCurrency(totalInCOP)}</td>
                <td>${formatCurrency(annualizedCostInCOP)}</td>
            </tr>
        `;
        tbody.insertAdjacentHTML('beforeend', row);
    });
    
    // Format total with the last used currency, or USD if no resources
    const defaultFormatter = new Intl.NumberFormat('es-CO', {
        style: 'currency',
        currency: projectData.resources.length > 0 ? projectData.resources[projectData.resources.length - 1].currency : 'USD',
        minimumFractionDigits: 2,
        maximumFractionDigits: 2
    });
    
    document.getElementById('totalUnitCost').textContent = formatCurrency(totalUnitCostCOP);
    document.getElementById('totalCost').textContent = formatCurrency(totalDirectCostCOP);
    document.getElementById('totalAnnualCost').textContent = formatCurrency(totalAnnualCostCOP);
}

function saveProjectData() {
    const projectTotals = calculateProjectTotals();
    
    // Calculate resource costs
    let totalResourcesCOP = 0;
    let totalAnnualResourcesCOP = 0;
    projectData.resources.forEach(resource => {
        const costInCOP = convertToCOP(resource.cost, resource.currency);
        const totalInCOP = costInCOP * resource.quantity;
        const annualizedCostInCOP = calculateAnnualizedCost({...resource, cost: costInCOP});
        totalResourcesCOP += totalInCOP;
        totalAnnualResourcesCOP += annualizedCostInCOP;
    });

    // Calculate freelance costs
    let totalFreelanceCost = 0;
    const freelanceData = [];
    document.querySelectorAll('#freelanceTable tr').forEach(row => {
        if (row.cells.length >= 6) {
            const specialty = row.cells[0].textContent;
            const level = row.cells[1].textContent;
            const rate = parseFloat(row.cells[2].textContent.replace(/[^0-9.]/g, ''));
            const activity = row.cells[3].textContent;
            const hours = parseFloat(row.cells[4].textContent);
            const cost = parseFloat(row.cells[5].textContent.replace(/[^0-9.]/g, ''));
            
            totalFreelanceCost += cost;
            freelanceData.push({
                specialty,
                level,
                rate,
                activity,
                hours,
                cost
            });
        }
    });

    const data = {
        projectId: projectData.projectId,
        projectName: projectData.projectName,
        timeEstimates: {
            entregables: projectData.entregables,
            totalHours: {
                optimistic: projectTotals.optimistic,
                mostLikely: projectTotals.mostLikely,
                pessimistic: projectTotals.pessimistic,
                estimated: projectTotals.estimated
            }
        },
        costs: {
            resources: {
                items: projectData.resources,
                totalDirectCost: totalResourcesCOP,
                totalAnnualCost: totalAnnualResourcesCOP
            },
            freelance: {
                items: freelanceData,
                totalCost: totalFreelanceCost
            },
            totalProjectCost: totalResourcesCOP + totalFreelanceCost
        }
    };

    fetch('/proyectos/calculadora', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify(data)
    })
    .then(response => response.json())
    .then(data => {
        alert('Proyecto guardado exitosamente');
    })
    .catch(error => {
        console.error('Error:', error);
        alert('Error al guardar el proyecto');
    });
}

function updateSummary() {
    let totalEntregables = projectData.entregables.length;
    let totalActividades = 0;
    let totalTareas = 0;
    let totalTime = 0;
    
    projectData.entregables.forEach(entregable => {
        totalActividades += entregable.actividades.length;
        entregable.actividades.forEach(actividad => {
            totalTareas += actividad.tareas.length;
        });
    });

    const projectTotals = calculateProjectTotals();
    totalTime = projectTotals.estimated;

    // Calcular costos de recursos
    let totalResourcesCOP = 0;
    projectData.resources.forEach(resource => {
        const costInCOP = convertToCOP(resource.cost, resource.currency);
        totalResourcesCOP += costInCOP * resource.quantity;
    });

    // Calcular costos de freelance
    let totalFreelanceCost = 0;
    const freelanceRows = document.querySelectorAll('#freelanceTable tr');
    let freelanceCount = 0;
    freelanceRows.forEach(row => {
        if (row.cells.length >= 6) {
            freelanceCount++;
            const costText = row.cells[5].textContent;
            const cleanText = costText.replace(/[^0-9.]/g, '');
            const cost = parseFloat(cleanText);
            if (!isNaN(cost)) {
                totalFreelanceCost += cost;
            }
        }
    });

    document.getElementById('summaryEntregables').textContent = totalEntregables;
    document.getElementById('summaryActividades').textContent = totalActividades;
    document.getElementById('summaryTareas').textContent = totalTareas;
    document.getElementById('summaryEntregablesTime').textContent = projectTotals.estimated.toFixed(1) + ' horas';
    document.getElementById('summaryActividadesTime').textContent = projectTotals.estimated.toFixed(1) + ' horas';
    document.getElementById('summaryTareasTime').textContent = projectTotals.estimated.toFixed(1) + ' horas';
    document.getElementById('summaryTotalTime').textContent = totalTime.toFixed(1) + ' horas';
    
    // Actualizar recursos y freelance
    document.getElementById('summaryResources').textContent = projectData.resources.length;
    document.getElementById('summaryResourcesCost').textContent = formatCurrency(totalResourcesCOP);
    document.getElementById('summaryFreelance').textContent = freelanceCount;
    document.getElementById('summaryFreelanceCost').textContent = formatCurrency(totalFreelanceCost);
    document.getElementById('summaryTotalCost').textContent = formatCurrency(totalResourcesCOP + totalFreelanceCost);
}

// Freelance Functions
function openFreelanceForm() {
    document.getElementById('freelanceFormPopup').classList.add('show');
    updateActivitySelect();
}

function closeFreelanceForm() {
    document.getElementById('freelanceFormPopup').classList.remove('show');
    document.getElementById('freelanceForm').reset();
}

function updateActivitySelect() {
    const activitySelect = document.getElementById('freelanceActivity');
    activitySelect.innerHTML = '<option value="">Seleccione...</option>';
    
    projectData.entregables.forEach(entregable => {
        entregable.actividades.forEach(actividad => {
            const option = document.createElement('option');
            option.value = actividad.id;
            option.textContent = `${entregable.name} - ${actividad.name}`;
            activitySelect.appendChild(option);
        });
    });
}

function updateRate() {
    const level = document.getElementById('level').value;
    const rateInput = document.getElementById('rate');
    const rateRange = document.getElementById('rateRange');
    
    let rate = 0;
    let range = '';
    
    switch(level) {
        case 'junior':
            rate = 9; // Default to middle of range
            range = 'Rango: 8-10 USD/hora';
            break;
        case 'mid':
            rate = 14.5; // Default to middle of range
            range = 'Rango: 12-17 USD/hora';
            break;
        case 'senior':
            rate = 24; // Default to middle of range
            range = 'Rango: 20-28 USD/hora';
            break;
        default:
            rate = 0;
            range = '';
    }
    
    rateInput.value = rate;
    rateRange.textContent = range;
}

function addFreelance(event) {
    event.preventDefault();
    
    const freelance = {
        id: Date.now(),
        specialty: document.getElementById('specialty').value,
        level: document.getElementById('level').value,
        rate: parseFloat(document.getElementById('rate').value),
        activityId: document.getElementById('freelanceActivity').value
    };
    
    // Find activity and its estimated hours
    let activityName = '';
    let estimatedHours = 0;
    
    projectData.entregables.forEach(entregable => {
        const activity = entregable.actividades.find(a => a.id == freelance.activityId);
        if (activity) {
            activityName = `${entregable.name} - ${activity.name}`;
            const totals = calculateActividadTotals(activity);
            estimatedHours = totals.estimated;
        }
    });
    
    const rateInCOP = convertToCOP(freelance.rate, 'USD'); // Freelance rates are in USD
    const totalCostInCOP = rateInCOP * estimatedHours;
    
    const tbody = document.getElementById('freelanceTable');
    const row = `
        <tr>
            <td>${freelance.specialty}</td>
            <td>${freelance.level}</td>
            <td>${formatCurrency(rateInCOP)} <small class="text-muted">(${formatCurrency(freelance.rate, 'USD')})</small></td>
            <td>${activityName}</td>
            <td>${estimatedHours.toFixed(1)}</td>
            <td>${formatCurrency(totalCostInCOP)}</td>
        </tr>
    `;
    tbody.insertAdjacentHTML('beforeend', row);
    
    updateTotalFreelanceCost();
    closeFreelanceForm();
}

function updateTotalFreelanceCost() {
    const rows = document.getElementById('freelanceTable').getElementsByTagName('tr');
    let total = 0;
    
    for (let row of rows) {
        if (row.cells.length >= 6) {
            const costCell = row.cells[5];
            // Extraer el valor numérico del texto con formato de moneda
            const costText = costCell.textContent;
            // Remover todo excepto números y puntos
            const cleanText = costText.replace(/[^0-9.]/g, '');
            const numericValue = parseFloat(cleanText);
            if (!isNaN(numericValue)) {
                total += numericValue;
            }
        }
    }
    
    document.getElementById('totalFreelanceCost').textContent = formatCurrency(total);
}

function renderProject() {
    const container = document.getElementById('projectStructure');
    container.innerHTML = '';
    
    projectData.entregables.forEach(entregable => {
        const entregableTotals = calculateEntregableTotals(entregable);
        const entregableHtml = `
            <div class="entregable-card">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <h5>${entregable.name}</h5>
                    <button class="btn btn-sm btn-primary add-button" onclick="openActividadForm(${entregable.id})">
                        <i data-feather="plus"></i> Actividad
                    </button>
                </div>
                <div class="card-body">
                    <div class="actividades-container">
                        ${renderActividades(entregable.actividades)}
                    </div>
                    <div class="totals-row entregable-totals">
                        <strong>Totales del Entregable:</strong>
                        <div class="time-items">
                            <span class="time-item">Optimista: ${entregableTotals.optimistic.toFixed(1)}h</span>
                            <span class="time-item">Más Probable: ${entregableTotals.mostLikely.toFixed(1)}h</span>
                            <span class="time-item">Pesimista: ${entregableTotals.pessimistic.toFixed(1)}h</span>
                            <span class="time-item">Estimado: ${entregableTotals.estimated.toFixed(1)}h</span>
                        </div>
                    </div>
                </div>
            </div>
        `;
        container.insertAdjacentHTML('beforeend', entregableHtml);
    });

    // Update project totals
    const projectTotals = calculateProjectTotals();
    document.getElementById('projectOptimistic').textContent = projectTotals.optimistic.toFixed(1);
    document.getElementById('projectMostLikely').textContent = projectTotals.mostLikely.toFixed(1);
    document.getElementById('projectPessimistic').textContent = projectTotals.pessimistic.toFixed(1);
    document.getElementById('projectEstimated').textContent = projectTotals.estimated.toFixed(1);

    // Re-initialize Feather icons
    if (window.feather) {
        feather.replace();
    }
    
    updateSummary();
}

function renderActividades(actividades) {
    return actividades.map(actividad => {
        const actividadTotals = calculateActividadTotals(actividad);
        return `
            <div class="actividad-card">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <h6>${actividad.name}</h6>
                    <button class="btn btn-sm btn-secondary add-button" onclick="openTareaForm(${actividad.id})">
                        <i data-feather="plus"></i> Tarea
                    </button>
                </div>
                <div class="card-body">
                    <div class="tareas-container">
                        ${renderTareas(actividad.tareas)}
                    </div>
                    <div class="totals-row actividad-totals">
                        <strong>Totales de la Actividad:</strong>
                        <div class="time-items">
                            <span class="time-item">Optimista: ${actividadTotals.optimistic.toFixed(1)}h</span>
                            <span class="time-item">Más Probable: ${actividadTotals.mostLikely.toFixed(1)}h</span>
                            <span class="time-item">Pesimista: ${actividadTotals.pessimistic.toFixed(1)}h</span>
                            <span class="time-item">Estimado: ${actividadTotals.estimated.toFixed(1)}h</span>
                        </div>
                    </div>
                </div>
            </div>
        `;
    }).join('');
}

function renderTareas(tareas) {
    return tareas.map(tarea => `
        <div class="tarea-row">
            <div class="d-flex justify-content-between align-items-center">
                <span>${tarea.name}</span>
                <div class="tarea-times">
                    <span class="time-item">Optimista: ${tarea.optimistic}h</span>
                    <span class="time-item">Más Probable: ${tarea.mostLikely}h</span>
                    <span class="time-item">Pesimista: ${tarea.pessimistic}h</span>
                    <span class="time-item">Estimado: ${calculateTareaEstimated(tarea).toFixed(1)}h</span>
                </div>
            </div>
        </div>
    `).join('');
}
</script>
{% endblock %}
