{% extends "layout.html" %}

{% block content %}
<div class="container-fluid">
    <!-- Header with action buttons -->
    <div class="dashboard-section-title">
        <h4>Gestión de Organizaciones</h4>
        <div class="action-buttons">
            <button type="button" class="action-button" data-bs-toggle="modal" data-bs-target="#addAliadoModal">
                <i data-feather="plus"></i>
            </button>
            <button type="button" class="action-button" data-bs-toggle="modal" data-bs-target="#dataManagementModal">
                <i data-feather="database"></i>
            </button>
        </div>
    </div>

    <!-- Filters -->
    <div class="card mb-4">
        <div class="card-body">
            <form id="filterForm" class="filter-form">
                <!-- Primera fila de filtros -->
                <div class="filter-row">
                    <div class="filter-group">
                        <label class="filter-label">Nombre</label>
                        <select class="filter-control" name="nombre">
                            <option value="">Todos los aliados</option>
                            {% for org in organizaciones %}
                            <option value="{{ org.nombre }}">{{ org.nombre }}</option>
                            {% endfor %}
                        </select>
                    </div>
                    <div class="filter-group">
                        <label class="filter-label">Industria</label>
                        <select class="filter-control" name="industria">
                            <option value="">Todas las industrias</option>
                            {% for ind in industrias %}
                            <option value="{{ ind.nombre }}">{{ ind.nombre }}</option>
                            {% endfor %}
                        </select>
                    </div>
                    <div class="filter-group">
                        <label class="filter-label">Estado</label>
                        <select class="filter-control" name="estado">
                            <option value="">Todos los estados</option>
                            <option value="activo">Activo</option>
                            <option value="inactivo">Inactivo</option>
                            <option value="pendiente">Pendiente</option>
                        </select>
                    </div>
                </div>

                <!-- Segunda fila de filtros -->
                <div class="filter-row">
                    <div class="filter-group">
                        <label class="filter-label">Región</label>
                        <select class="filter-control" name="region">
                            <option value="">Todas las regiones</option>
                            {% for reg in regiones %}
                            <option value="{{ reg.nombre }} ({{ reg.codigo }})">{{ reg.nombre }} ({{ reg.codigo }})</option>
                            {% endfor %}
                        </select>
                    </div>
                    <div class="filter-group">
                        <label class="filter-label">Subregión</label>
                        <select class="filter-control" name="subregion">
                            <option value="">Todas las subregiones</option>
                            {% for sreg in subregiones %}
                            <option value="{{ sreg.nombre }} ({{ sreg.codigo }})">{{ sreg.nombre }} ({{ sreg.codigo }})</option>
                            {% endfor %}
                        </select>
                    </div>
                    <div class="filter-group">
                        <label class="filter-label">País</label>
                        <select class="filter-control" name="pais">
                            <option value="">Todos los países</option>
                            {% for ps in paises %}
                            <option value="{{ ps.pais }}">{{ ps.pais }}</option>
                            {% endfor %}
                        </select>
                    </div>
                </div>
            </form>
        </div>
    </div>

    <!-- Aliados Table -->
    <div class="card">
        <div class="card-body">
            <div class="table-responsive">
                <table class="table table-hover align-middle mb-0" id="aliadosTable">
                    <thead>
                        <tr>
                            <th>Nombre</th>
                            <th>Industria</th>
                            <th>Estado</th>
                            <th>Región</th>
                            <th>Subregión</th>
                            <th>País</th>
                            <th>Sede</th>
                            <th>Acciones</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for torg in table_orgs %}
                        <tr data-nombre="{{ torg[0] }}" data-industria="{{ torg[1] }}" data-region="{{ torg[3] }}">
                            <td>
                                <div class="d-flex align-items-center">
                                    <div class="avatar-circle me-2">{{ torg[0] }}</div>
                                    <div>{{ torg[0] }}</div>
                                </div>
                            </td>
                            <td>{{ torg[1] }}</td>
                            <td>
                                <span class="badge {% if torg[2] == 19 %}bg-warning{% elif torg[2] == 17 %}bg-success{% else %}bg-primary{% endif %}">
                                    {% if torg[2] == 17 %} Activo {% elif torg[2] == 19 %} Pendiente {% else %} Inactivo {% endif %}
                                </span>
                            </td>
                            <td>
                                {{ torg[3] }}
                            </td>
                            <td>
                                {{ torg[4] }}
                            </td>
                            <td>
                                {{ torg[5] }}
                            </td>
                            <td>
                                {{ torg[6] }}
                            </td>
                            <td>
                                <div class="btn-group">
                                    <button type="button" class="btn btn-sm btn-icon" title="Editar">
                                        <i data-feather="edit-2"></i>
                                    </button>
                                    <button type="button" class="btn btn-sm btn-icon" title="Ver detalles">
                                        <i data-feather="eye"></i>
                                    </button>
                                    <button type="button" class="btn btn-sm btn-icon text-danger" title="Eliminar">
                                        <i data-feather="trash-2"></i>
                                    </button>
                                </div>
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>
    </div>
</div>

<!-- Modal Añadir Aliado -->
<div class="modal fade" id="addAliadoModal" tabindex="-1" aria-labelledby="addAliadoModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-xl">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="addAliadoModalLabel">Gestión de Aliados</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <!-- Selector de tipo de formulario -->
                <div class="form-type-selector mb-4">
                    <div class="row">
                        <div class="col-md-6">
                            <div class="form-option" onclick="selectFormType('organizacion')">
                                <div class="form-option-icon">
                                    <i data-feather="building-2" class="text-primary"></i>
                                </div>
                                <div class="form-option-content">
                                    <h5 class="form-option-title">Crear Organización</h5>
                                    <p class="form-option-desc">Registrar una nueva organización aliada</p>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="form-option" onclick="selectFormType('sede')">
                                <div class="form-option-icon">
                                    <i data-feather="map-pin" class="text-success"></i>
                                </div>
                                <div class="form-option-content">
                                    <h5 class="form-option-title">Agregar Sede</h5>
                                    <p class="form-option-desc">Añadir una nueva sede a organización existente</p>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Formulario Crear Organización -->
                <div id="formOrganizacion" class="form-container" style="display: none;">
                    <h6 class="form-section-title">Datos de la Organización</h6>
                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="orgNombre" class="form-label">Nombre</label>
                                <input type="text" class="form-control" id="orgNombre" placeholder="Nombre de la organización">
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="orgIndustria" class="form-label">Industria</label>
                                <select class="form-select" id="orgIndustria">
                                    <option value="">Seleccionar industria...</option>
                                    {% for i in industrias %}
                                    <option value="{{ i.id }}">{{ i.nombre }} ({{ i.grupo_general }})</option>
                                    {% endfor %}
                                </select>
                            </div>
                        </div>
                    </div>
                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="orgEstado" class="form-label">Estado</label>
                                <select class="form-select" id="orgEstado">
                                    <option value="">Seleccionar estado...</option>
                                    <option value="activo">Activo</option>
                                    <option value="inactivo">Inactivo</option>
                                    <option value="pendiente">Pendiente</option>
                                </select>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="orgContacto" class="form-label">Contacto Principal</label>
                                <input type="text" class="form-control" id="orgContacto" placeholder="Número de contacto principal">
                            </div>
                        </div>
                    </div>
                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="orgTamano" class="form-label">Tamaño</label>
                                <select class="form-select" id="orgTamano">
                                    <option value="">Seleccionar tamaño...</option>
                                    <option value="pequeña">Pequeña</option>
                                    <option value="mediana">Mediana</option>
                                    <option value="grande">Grande</option>
                                </select>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="orgEmpleados" class="form-label">Empleados</label>
                                <input type="number" class="form-control" id="orgEmpleados" placeholder="Cantidad de empleados" min="1">
                            </div>
                        </div>
                    </div>

                    <h6 class="form-section-title">Datos de la Sede</h6>
                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="orgNombreSede" class="form-label">Nombre Sede</label>
                                <input type="text" class="form-control" id="orgNombreSede" placeholder="Nombre de la sede">
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="orgRegion" class="form-label">Región</label>
                                <select class="form-select" id="orgRegion">
                                    <option value="">Seleccionar región...</option>
                                    {% for r in regiones %}
                                    <option value="{{ r.id }}">{{ r.nombre }} ({{ r.codigo }})</option>
                                    {% endfor %}
                                </select>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="orgDireccion" class="form-label">Dirección</label>
                                <input type="text" class="form-control" id="orgDireccion" placeholder="Dirección completa">
                            </div>
                        </div>
                    </div>
                    <div class="row">
                        <div class="col-md-4">
                            <div class="mb-3">
                                <label for="orgCiudad" class="form-label">Ciudad</label>
                                <input type="text" class="form-control" id="orgCiudad" placeholder="Ciudad">
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="mb-3">
                                <label for="orgCodigoPostal" class="form-label">Código Postal</label>
                                <input type="text" class="form-control" id="orgCodigoPostal" placeholder="Código postal">
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="mb-3">
                                <label for="orgPais" class="form-label">País</label>
                                <input type="text" class="form-control" id="orgPais" placeholder="País">
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Formulario Agregar Sede -->
                <div id="formSede" class="form-container" style="display: none;">
                    <h6 class="form-section-title">Información de la Sede</h6>
                    <div class="mb-3">
                        <label for="sedeOrganizacion" class="form-label">Organización</label>
                        <select class="form-select" id="sedeOrganizacion">
                            <option value="">Seleccionar organización...</option>
                            {% for org in organizaciones %}
                            <option value="{{ org.id }}">{{ org.nombre }}</option>
                            {% endfor %}
                        </select>
                    </div>
                    <div class="col-md-6">
                        <div class="mb-3">
                            <label for="sedeNombreSede" class="form-label">Nombre sede</label>
                            <input type="text" class="form-control" id="sedeNombreSede" placeholder="Nombre de la sede">
                        </div>
                    </div>
                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="sedeRegion" class="form-label">Región</label>
                                <select class="form-select" id="sedeRegion">
                                    <option value="">Seleccionar región...</option>
                                    {% for r in subregiones %}
                                    <option value="{{ r.id }}">{{ r.nombre }} ({{ r.codigo }})</option>
                                    {% endfor %}
                                </select>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="sedeDireccion" class="form-label">Dirección</label>
                                <input type="text" class="form-control" id="sedeDireccion" placeholder="Dirección completa">
                            </div>
                        </div>
                    </div>
                    <div class="row">
                        <div class="col-md-4">
                            <div class="mb-3">
                                <label for="sedeCiudad" class="form-label">Ciudad</label>
                                <input type="text" class="form-control" id="sedeCiudad" placeholder="Ciudad">
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="mb-3">
                                <label for="sedeCodigoPostal" class="form-label">Código Postal</label>
                                <input type="text" class="form-control" id="sedeCodigoPostal" placeholder="Código postal">
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="mb-3">
                                <label for="sedePais" class="form-label">País</label>
                                <input type="text" class="form-control" id="sedePais" placeholder="País">
                            </div>
                        </div>
                    </div>
                </div>

            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                <button type="button" class="btn btn-primary" onclick="submitForm()">Guardar</button>
            </div>
        </div>
    </div>
</div>

<!-- Modal Gestión de Datos -->
<div class="modal fade" id="dataManagementModal" tabindex="-1" aria-labelledby="dataManagementModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="dataManagementModalLabel">Gestión de Datos</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <!-- Selector de tipo de operación -->
                <div class="data-type-selector mb-4">
                    <div class="row">
                        <div class="col-md-6">
                            <div class="data-option" onclick="selectDataType('import')">
                                <div class="data-option-icon">
                                    <i data-feather="upload" class="text-primary"></i>
                                </div>
                                <div class="data-option-content">
                                    <h5 class="data-option-title">Cargar Masivamente</h5>
                                    <p class="data-option-desc">Importar aliados desde un archivo Excel/CSV</p>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="data-option" onclick="selectDataType('export')">
                                <div class="data-option-icon">
                                    <i data-feather="download" class="text-success"></i>
                                </div>
                                <div class="data-option-content">
                                    <h5 class="data-option-title">Exportar Datos</h5>
                                    <p class="data-option-desc">Generar archivo Excel/CSV con datos actuales</p>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Formulario Importar -->
                <div id="importForm" class="data-container" style="display: none;">
                    <h6 class="data-section-title">Cargar Archivo</h6>
                    <div class="mb-3">
                        <label for="importFile" class="form-label">Seleccionar archivo</label>
                        <input type="file" class="form-control" id="importFile" accept=".xlsx,.xls,.csv" required>
                        <div class="form-text">Formatos soportados: Excel (.xlsx, .xls) y CSV (.csv)</div>
                    </div>
                    <div class="mb-3">
                        <div class="form-check">
                            <input class="form-check-input" type="checkbox" id="overwriteData">
                            <label class="form-check-label" for="overwriteData">
                                Sobrescribir datos existentes
                            </label>
                        </div>
                    </div>
                    <div class="alert alert-info">
                        <strong>Formato esperado:</strong><br>
                        Las columnas deben ser: Nombre, Industria, Estado, Región, Subregión, País, Sede, Contacto, Empleados
                    </div>
                </div>

                <!-- Formulario Exportar -->
                <div id="exportForm" class="data-container" style="display: none;">
                    <h6 class="data-section-title">Opciones de Exportación</h6>
                    <div class="mb-3">
                        <label for="exportFormat" class="form-label">Formato de archivo</label>
                        <select class="form-select" id="exportFormat">
                            <option value="xlsx">Excel (.xlsx)</option>
                            <option value="csv">CSV (.csv)</option>
                        </select>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Datos a incluir</label>
                        <div class="form-check">
                            <input class="form-check-input" type="checkbox" id="includeAll" checked>
                            <label class="form-check-label" for="includeAll">
                                Todos los aliados
                            </label>
                        </div>
                        <div class="form-check">
                            <input class="form-check-input" type="checkbox" id="includeFiltered">
                            <label class="form-check-label" for="includeFiltered">
                                Solo aliados filtrados actualmente
                            </label>
                        </div>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Columnas a exportar</label>
                        <div class="row">
                            <div class="col-md-6">
                                <div class="form-check">
                                    <input class="form-check-input" type="checkbox" id="colNombre" checked>
                                    <label class="form-check-label" for="colNombre">Nombre</label>
                                </div>
                                <div class="form-check">
                                    <input class="form-check-input" type="checkbox" id="colIndustria" checked>
                                    <label class="form-check-label" for="colIndustria">Industria</label>
                                </div>
                                <div class="form-check">
                                    <input class="form-check-input" type="checkbox" id="colEstado" checked>
                                    <label class="form-check-label" for="colEstado">Estado</label>
                                </div>
                                <div class="form-check">
                                    <input class="form-check-input" type="checkbox" id="colRegion" checked>
                                    <label class="form-check-label" for="colRegion">Región</label>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="form-check">
                                    <input class="form-check-input" type="checkbox" id="colSubregion" checked>
                                    <label class="form-check-label" for="colSubregion">Subregión</label>
                                </div>
                                <div class="form-check">
                                    <input class="form-check-input" type="checkbox" id="colPais" checked>
                                    <label class="form-check-label" for="colPais">País</label>
                                </div>
                                <div class="form-check">
                                    <input class="form-check-input" type="checkbox" id="colSede" checked>
                                    <label class="form-check-label" for="colSede">Sede</label>
                                </div>
                                <div class="form-check">
                                    <input class="form-check-input" type="checkbox" id="colContacto">
                                    <label class="form-check-label" for="colContacto">Contacto</label>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                <button type="button" class="btn btn-primary" onclick="executeDataAction()">Ejecutar</button>
            </div>
        </div>
    </div>
</div>

<style>
.dashboard-section-title {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 1.5rem;
}

.action-buttons {
    display: flex;
    gap: 0.5rem;
}

.action-button {
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    border: none;
    border-radius: 8px;
    padding: 8px 12px;
    color: white;
    cursor: pointer;
    transition: all 0.3s ease;
}

.action-button:hover {
    transform: translateY(-1px);
    box-shadow: 0 4px 12px rgba(102, 126, 234, 0.4);
}

.filter-form {
    background: linear-gradient(135deg, #f8f9fa 0%, #ffffff 100%);
    border-radius: 16px;
    padding: 2rem;
    box-shadow: 0 4px 20px rgba(0, 0, 0, 0.08);
    border: 1px solid rgba(102, 126, 234, 0.1);
}

.filter-row {
    display: grid;
    grid-template-columns: repeat(3, 1fr);
    gap: 1.5rem;
    margin-bottom: 1.5rem;
}

.filter-group {
    display: flex;
    flex-direction: column;
}

.filter-label {
    font-weight: 600;
    color: var(--primary);
    margin-bottom: 0.5rem;
    font-size: 0.9rem;
    text-transform: uppercase;
    letter-spacing: 0.5px;
}

.filter-control {
    padding: 12px 16px;
    border: 2px solid #e1e8ed;
    border-radius: 12px;
    background: white;
    color: var(--dark);
    font-size: 0.95rem;
    transition: all 0.3s ease;
    box-shadow: 0 2px 8px rgba(0, 0, 0, 0.05);
}

.filter-control:focus {
    border-color: var(--secondary);
    outline: none;
    box-shadow: 0 0 0 4px rgba(52, 152, 219, 0.15);
    transform: translateY(-1px);
}

.filter-control:hover {
    border-color: var(--secondary);
    box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
}

/* Responsive design */
@media (max-width: 1024px) {
    .filter-row {
        grid-template-columns: repeat(2, 1fr);
        gap: 1rem;
    }
    
    .filter-form {
        padding: 1.5rem;
    }
}

@media (max-width: 768px) {
    .filter-row {
        grid-template-columns: 1fr;
        gap: 1rem;
    }
    
    .filter-form {
        padding: 1rem;
    }
    
    .filter-control {
        padding: 10px 14px;
        font-size: 0.9rem;
    }
}

.avatar-circle {
    width: 32px;
    height: 32px;
    background-color: var(--primary);
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    color: white;
    font-weight: bold;
}

.btn-icon {
    width: 32px;
    height: 32px;
    padding: 0;
    display: flex;
    align-items: center;
    justify-content: center;
    border: 1px solid #dee2e6;
    background: white;
    border-radius: 6px;
}

.btn-icon:hover {
    background: #f8f9fa;
}

.form-type-selector {
    margin-bottom: 2rem;
}

.form-option {
    border: 2px solid #e9ecef;
    border-radius: 12px;
    padding: 1.5rem;
    cursor: pointer;
    transition: all 0.3s ease;
    height: 100%;
    display: flex;
    align-items: center;
}

.form-option:hover {
    border-color: #667eea;
    background: #f8f9ff;
}

.form-option.active {
    border-color: #667eea;
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    color: white;
}

.form-option-icon {
    margin-right: 1rem;
    font-size: 1.5rem;
}

.form-option-title {
    margin: 0 0 0.25rem 0;
    font-size: 1.1rem;
    font-weight: 600;
}

.form-option-desc {
    margin: 0;
    font-size: 0.9rem;
    opacity: 0.8;
}

.form-container {
    background: #f8f9fa;
    border-radius: 12px;
    padding: 1.5rem;
}

.form-section-title {
    color: #667eea;
    font-weight: 600;
    margin-bottom: 1rem;
    padding-bottom: 0.5rem;
    border-bottom: 2px solid #e9ecef;
}

/* Modal overlay styles */
.modal {
    position: fixed;
    top: 0;
    left: 0;
    z-index: 1055;
    width: 100%;
    height: 100%;
    overflow-x: hidden;
    overflow-y: auto;
    background-color: rgba(0, 0, 0, 0.5);
    display: none;
}

.modal.show {
    display: flex !important;
    align-items: center;
    justify-content: center;
}

.modal-dialog {
    position: relative;
    margin: 1.75rem auto;
    max-width: 90%;
    pointer-events: none;
}

.modal-xl {
    max-width: 1140px;
}

.modal-content {
    position: relative;
    background-color: #fff;
    border: none;
    border-radius: 0.5rem;
    box-shadow: 0 0.5rem 1rem rgba(0, 0, 0, 0.15);
    pointer-events: auto;
    max-height: 90vh;
    overflow-y: auto;
}

.modal-header {
    display: flex;
    align-items: center;
    justify-content: space-between;
    padding: 1rem 1.5rem;
    border-bottom: 1px solid #dee2e6;
    border-top-left-radius: 0.5rem;
    border-top-right-radius: 0.5rem;
}

.modal-body {
    position: relative;
    flex: 1 1 auto;
    padding: 1.5rem;
}

.modal-footer {
    display: flex;
    align-items: center;
    justify-content: flex-end;
    padding: 1rem 1.5rem;
    border-top: 1px solid #dee2e6;
    border-bottom-right-radius: 0.5rem;
    border-bottom-left-radius: 0.5rem;
    gap: 0.5rem;
}

.btn-close {
    background: none;
    border: none;
    font-size: 1.25rem;
    font-weight: 700;
    line-height: 1;
    color: #000;
    opacity: 0.5;
    cursor: pointer;
}

.btn-close:hover {
    opacity: 0.75;
}

/* Estilos específicos para formularios del modal */
.modal-body .form-label {
    font-weight: 600;
    color: var(--primary);
    margin-bottom: 0.5rem;
    font-size: 0.9rem;
    text-transform: uppercase;
    letter-spacing: 0.5px;
}

.modal-body .form-control,
.modal-body .form-select {
    padding: 12px 16px;
    border: 2px solid #e1e8ed;
    border-radius: 12px;
    background: white;
    color: var(--dark);
    font-size: 0.95rem;
    transition: all 0.3s ease;
    box-shadow: 0 2px 8px rgba(0, 0, 0, 0.05);
    width: 100%;
}

.modal-body .form-control:focus,
.modal-body .form-select:focus {
    border-color: var(--secondary);
    outline: none;
    box-shadow: 0 0 0 4px rgba(52, 152, 219, 0.15);
    transform: translateY(-1px);
}

.modal-body .form-control:hover,
.modal-body .form-select:hover {
    border-color: var(--secondary);
    box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
}

.modal-body .form-select {
    background-image: url("data:image/svg+xml,%3csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 16 16'%3e%3cpath fill='none' stroke='%23667eea' stroke-linecap='round' stroke-linejoin='round' stroke-width='2' d='M2 5l6 6 6-6'/%3e%3c/svg%3e");
    background-repeat: no-repeat;
    background-position: right 12px center;
    background-size: 16px 12px;
    appearance: none;
    cursor: pointer;
}

.modal-body .mb-3 {
    margin-bottom: 1.5rem;
}

.modal-body .row {
    margin-left: -0.75rem;
    margin-right: -0.75rem;
}

.modal-body .row > * {
    padding-left: 0.75rem;
    padding-right: 0.75rem;
}

/* Estilos para botones del modal */
.modal-footer .btn {
    padding: 12px 24px;
    border-radius: 12px;
    font-weight: 600;
    font-size: 0.95rem;
    transition: all 0.3s ease;
    border: none;
    cursor: pointer;
}

.modal-footer .btn-primary {
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    color: white;
    box-shadow: 0 4px 12px rgba(102, 126, 234, 0.3);
}

.modal-footer .btn-primary:hover {
    transform: translateY(-2px);
    box-shadow: 0 6px 20px rgba(102, 126, 234, 0.4);
}

.modal-footer .btn-secondary {
    background: #f8f9fa;
    color: #6c757d;
    border: 2px solid #e9ecef;
}

.modal-footer .btn-secondary:hover {
    background: #e9ecef;
    border-color: #dee2e6;
    transform: translateY(-1px);
}

/* Responsive para modal */
@media (max-width: 768px) {
    .modal-dialog {
        margin: 0.5rem;
        max-width: calc(100% - 1rem);
    }
    
    .modal-body {
        padding: 1rem;
    }
    
    .modal-body .form-control,
    .modal-body .form-select {
        padding: 10px 14px;
        font-size: 0.9rem;
    }
    
    .modal-footer {
        padding: 1rem;
        flex-direction: column;
    }
    
    .modal-footer .btn {
        width: 100%;
        margin-bottom: 0.5rem;
    }
}

/* Estilos para modal de gestión de datos */
.data-type-selector {
    margin-bottom: 2rem;
}

.data-option {
    border: 2px solid #e9ecef;
    border-radius: 12px;
    padding: 1.5rem;
    cursor: pointer;
    transition: all 0.3s ease;
    height: 100%;
    display: flex;
    align-items: center;
}

.data-option:hover {
    border-color: #667eea;
    background: #f8f9ff;
}

.data-option.active {
    border-color: #667eea;
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    color: white;
}

.data-option-icon {
    margin-right: 1rem;
    font-size: 1.5rem;
}

.data-option-title {
    margin: 0 0 0.25rem 0;
    font-size: 1.1rem;
    font-weight: 600;
}

.data-option-desc {
    margin: 0;
    font-size: 0.9rem;
    opacity: 0.8;
}

.data-container {
    background: #f8f9fa;
    border-radius: 12px;
    padding: 1.5rem;
}

.data-section-title {
    color: #667eea;
    font-weight: 600;
    margin-bottom: 1rem;
    padding-bottom: 0.5rem;
    border-bottom: 2px solid #e9ecef;
}

.form-check {
    margin-bottom: 0.5rem;
}

.form-check-input:checked {
    background-color: #667eea;
    border-color: #667eea;
}

.alert-info {
    background-color: #e3f2fd;
    border-color: #bbdefb;
    color: #1976d2;
}
</style>

<script>
// Variables globales
let selectedFormType = null;
let selectedDataType = null;

// Inicialización cuando el DOM esté listo
document.addEventListener('DOMContentLoaded', function() {
    console.log('DOM cargado, inicializando...');
    
    // Inicializar Feather icons
    if (typeof feather !== 'undefined') {
        feather.replace();
        console.log('Feather icons inicializados');
    }

    // Inicializar filtros
    initializeFilters();
    
    // Inicializar eventos del modal
    initializeModalEvents();
    
    // Inicializar eventos del modal de gestión de datos
    initializeDataModalEvents();
    
    // Verificar que Bootstrap esté disponible
    if (typeof bootstrap !== 'undefined') {
        console.log('Bootstrap disponible');
    } else {
        console.warn('Bootstrap no disponible');
    }
});

// Función para inicializar eventos del modal
function initializeModalEvents() {
    const modal = document.getElementById('addAliadoModal');
    if (!modal) {
        console.error('Modal addAliadoModal no encontrado');
        return;
    }
    
    console.log('Inicializando eventos del modal');
    
    // Configurar botones que abren el modal
    const openModalButtons = document.querySelectorAll('[data-bs-toggle="modal"][data-bs-target="#addAliadoModal"]');
    openModalButtons.forEach(button => {
        button.addEventListener('click', function(e) {
            e.preventDefault();
            showModal('addAliadoModal');
        });
    });
    
    // Configurar botones que cierran el modal
    const closeModalButtons = modal.querySelectorAll('[data-bs-dismiss="modal"]');
    closeModalButtons.forEach(button => {
        button.addEventListener('click', function(e) {
            e.preventDefault();
            hideModal('addAliadoModal');
        });
    });
    
    // Cerrar modal al hacer click en el backdrop
    modal.addEventListener('click', function(e) {
        if (e.target === modal) {
            hideModal('addAliadoModal');
        }
    });
    
    // Inicializar opciones de formulario
    const formOptions = modal.querySelectorAll('.form-option');
    formOptions.forEach((option, index) => {
        option.addEventListener('click', function(e) {
            e.preventDefault();
            const type = index === 0 ? 'organizacion' : 'sede';
            console.log('Seleccionando tipo de formulario:', type);
            selectFormType(type, this);
        });
    });
}

// Función para mostrar modal
function showModal(modalId) {
    console.log('Mostrando modal:', modalId);
    const modal = document.getElementById(modalId);
    
    if (!modal) {
        console.error('Modal no encontrado:', modalId);
        return;
    }
    
    // Resetear formulario
    resetModalForm();
    
    // Mostrar modal
    modal.style.display = 'flex';
    modal.classList.add('show');
    modal.setAttribute('aria-hidden', 'false');
    
    // Prevenir scroll del body
    document.body.style.overflow = 'hidden';
    
    // Reinicializar iconos de Feather
    if (typeof feather !== 'undefined') {
        setTimeout(() => feather.replace(), 100);
    }
    
    console.log('Modal mostrado correctamente:', modalId);
}

// Función para ocultar modal
function hideModal(modalId) {
    console.log('Ocultando modal:', modalId);
    const modal = document.getElementById(modalId);
    
    if (!modal) {
        console.error('Modal no encontrado:', modalId);
        return;
    }
    
    // Ocultar modal
    modal.style.display = 'none';
    modal.classList.remove('show');
    modal.setAttribute('aria-hidden', 'true');
    
    // Restaurar scroll del body
    document.body.style.overflow = '';
    
    // Resetear formulario
    resetModalForm();
    
    console.log('Modal ocultado correctamente:', modalId);
}

// Función para resetear el formulario del modal
function resetModalForm() {
    console.log('Reseteando formulario del modal');
    selectedFormType = null;
    selectedDataType = null;
    
    // Resetear modal de aliados
    document.querySelectorAll('.form-option').forEach(option => {
        option.classList.remove('active');
    });

    const formOrg = document.getElementById('formOrganizacion');
    const formSede = document.getElementById('formSede');
    
    if (formOrg) {
        formOrg.style.display = 'none';
        const inputs = formOrg.querySelectorAll('input, select');
        inputs.forEach(input => input.value = '');
    }
    
    if (formSede) {
        formSede.style.display = 'none';
        const inputs = formSede.querySelectorAll('input, select');
        inputs.forEach(input => input.value = '');
    }
    
    // Resetear modal de gestión de datos
    document.querySelectorAll('.data-option').forEach(option => {
        option.classList.remove('active');
    });

    const importForm = document.getElementById('importForm');
    const exportForm = document.getElementById('exportForm');
    
    if (importForm) {
        importForm.style.display = 'none';
        const inputs = importForm.querySelectorAll('input, select');
        inputs.forEach(input => {
            if (input.type === 'checkbox') {
                input.checked = false;
            } else {
                input.value = '';
            }
        });
    }
    
    if (exportForm) {
        exportForm.style.display = 'none';
        const inputs = exportForm.querySelectorAll('input, select');
        inputs.forEach(input => {
            if (input.type === 'checkbox') {
                // Restablecer valores por defecto para checkboxes de exportación
                if (input.id === 'includeAll' || input.id.startsWith('col')) {
                    input.checked = true;
                } else {
                    input.checked = false;
                }
            } else {
                input.value = input.defaultValue || '';
            }
        });
    }
}

// Función para seleccionar tipo de formulario
function selectFormType(type, element) {
    console.log('Seleccionando tipo:', type);
    selectedFormType = type;

    // Remover clase active de todas las opciones
    document.querySelectorAll('.form-option').forEach(option => {
        option.classList.remove('active');
    });

    // Agregar clase active a la opción seleccionada
    if (element) {
        element.classList.add('active');
    }

    // Obtener elementos del DOM
    const formOrganizacion = document.getElementById('formOrganizacion');
    const formSede = document.getElementById('formSede');

    // Ocultar todos los formularios
    if (formOrganizacion) formOrganizacion.style.display = 'none';
    if (formSede) formSede.style.display = 'none';

    // Mostrar el formulario correspondiente
    if (type === 'organizacion' && formOrganizacion) {
        formOrganizacion.style.display = 'block';
        console.log('Mostrando formulario de organización');
    } else if (type === 'sede' && formSede) {
        formSede.style.display = 'block';
        console.log('Mostrando formulario de sede');
    }
}

// Función para enviar formulario
function submitForm() {
    console.log('Enviando formulario, tipo seleccionado:', selectedFormType);
    
    if (!selectedFormType) {
        alert('Por favor selecciona un tipo de formulario');
        return;
    }

    let formData = {
        tipo: selectedFormType
    };

    // Validar campos requeridos según el tipo
    let isValid = true;

    if (selectedFormType === 'organizacion') {
        const orgNombre = document.getElementById('orgNombre');
        
        if (!orgNombre || !orgNombre.value.trim()) {
            alert('El nombre de la organización es requerido');
            isValid = false;
        }
        
        if (isValid) {
            const orgIndustria = document.getElementById('orgIndustria');
            const orgEstado = document.getElementById('orgEstado');
            const orgContacto = document.getElementById('orgContacto');
            const orgTamano = document.getElementById('orgTamano');
            const orgEmpleados = document.getElementById('orgEmpleados');
            const orgNombreSede = document.getElementById('orgNombreSede');
            const orgRegion = document.getElementById('orgRegion');
            const orgDireccion = document.getElementById('orgDireccion');
            const orgCiudad = document.getElementById('orgCiudad');
            const orgCodigoPostal = document.getElementById('orgCodigoPostal');
            const orgPais = document.getElementById('orgPais');

            formData = {
                ...formData,
                nombre: orgNombre.value,
                industria: orgIndustria ? orgIndustria.value : '',
                estado: orgEstado ? orgEstado.value : '',
                contacto: orgContacto ? orgContacto.value : '',
                tamano: orgTamano ? orgTamano.value : '',
                nombreSede: orgNombreSede ? orgNombreSede.value : '',
                empleados: orgEmpleados ? orgEmpleados.value : '',
                region: orgRegion ? orgRegion.value : '',
                direccion: orgDireccion ? orgDireccion.value : '',
                ciudad: orgCiudad ? orgCiudad.value : '',
                codigo_postal: orgCodigoPostal ? orgCodigoPostal.value : '',
                pais: orgPais ? orgPais.value : ''
            };
        }
    } else if (selectedFormType === 'sede') {
        const sedeOrganizacion = document.getElementById('sedeOrganizacion');
        
        if (!sedeOrganizacion || !sedeOrganizacion.value) {
            alert('Debe seleccionar una organización');
            isValid = false;
        }
        
        if (isValid) {
            const sedeNombreSede = document.getElementById('sedeNombreSede');
            const sedeRegion = document.getElementById('sedeRegion');
            const sedeDireccion = document.getElementById('sedeDireccion');
            const sedeCiudad = document.getElementById('sedeCiudad');
            const sedeCodigoPostal = document.getElementById('sedeCodigoPostal');
            const sedePais = document.getElementById('sedePais');

            formData = {
                ...formData,
                organizacion: sedeOrganizacion.value,
                nombreSede: sedeNombreSede ? sedeNombreSede.value : '',
                region: sedeRegion ? sedeRegion.value : '',
                direccion: sedeDireccion ? sedeDireccion.value : '',
                ciudad: sedeCiudad ? sedeCiudad.value : '',
                codigo_postal: sedeCodigoPostal ? sedeCodigoPostal.value : '',
                pais: sedePais ? sedePais.value : ''
            };
        }
    }

    if (!isValid) return;

    console.log('Datos del formulario:', formData);

    // Enviar al backend
    fetch('/api/organizaciones', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json'
        },
        body: JSON.stringify(formData)
    })
    .then(response => {
        if (!response.ok) throw new Error('Error en la respuesta del servidor');
        return response.json(); // o response.text() según tu backend
    })
    .then(data => {
        console.log('Respuesta del servidor:', data);

        // Cerrar modal usando Bootstrap
        const modal = document.getElementById('addAliadoModal');
        if (modal && typeof bootstrap !== 'undefined') {
            const bootstrapModal = bootstrap.Modal.getInstance(modal) || new bootstrap.Modal(modal);
            bootstrapModal.hide();
        }

        // Recargar la página
        location.reload();
    })
    .catch(error => {
        console.error('Error al enviar el formulario:', error);
        alert('Error al guardar los datos');
    });
    
    // Cerrar modal usando Bootstrap
    const modal = document.getElementById('addAliadoModal');
    if (modal && typeof bootstrap !== 'undefined') {
        const bootstrapModal = bootstrap.Modal.getInstance(modal) || new bootstrap.Modal(modal);
        bootstrapModal.hide();
    }
}

// Función para inicializar filtros
function initializeFilters() {
    const filterForm = document.getElementById('filterForm');
    const table = document.getElementById('aliadosTable');
    
    if (!filterForm || !table) {
        console.error('Filter form or table not found');
        return;
    }
    
    console.log('Inicializando filtros');
    const tableRows = table.querySelectorAll('tbody tr');
    
    // Poblar dinámicamente las opciones del filtro de nombre
    populateNameFilter();
    
    // Agregar event listeners a todos los campos de filtro
    const filterInputs = filterForm.querySelectorAll('select');
    filterInputs.forEach(input => {
        if (input && typeof input.addEventListener === 'function') {
            input.addEventListener('change', applyFilters);
        }
    });

    function populateNameFilter() {
        const nameSelect = filterForm.querySelector('[name="nombre"]');
        if (!nameSelect) return;
        
        // Limpiar opciones existentes excepto "Todos"
        nameSelect.innerHTML = '<option value="">Todos</option>';
        
        // Extraer nombres únicos de las filas de la tabla
        const uniqueNames = new Set();
        tableRows.forEach(row => {
            if (row.cells && row.cells[0]) {
                const nameCell = row.cells[0].querySelector('div:last-child');
                if (nameCell) {
                    const name = nameCell.textContent.trim();
                    if (name) uniqueNames.add(name);
                }
            }
        });
        
        // Agregar opciones al select
        Array.from(uniqueNames).sort().forEach(name => {
            const option = document.createElement('option');
            option.value = name;
            option.textContent = name;
            nameSelect.appendChild(option);
        });
    }

    function applyFilters() {
        const nameFilter = filterForm.querySelector('[name="nombre"]');
        const industriaFilter = filterForm.querySelector('[name="industria"]');
        const estadoFilter = filterForm.querySelector('[name="estado"]');
        const regionFilter = filterForm.querySelector('[name="region"]');
        const subregionFilter = filterForm.querySelector('[name="subregion"]');
        const paisFilter = filterForm.querySelector('[name="pais"]');
        
        const filters = {
            nombre: nameFilter ? nameFilter.value.toLowerCase() : '',
            industria: industriaFilter ? industriaFilter.value.toLowerCase() : '',
            estado: estadoFilter ? estadoFilter.value.toLowerCase() : '',
            region: regionFilter ? regionFilter.value.toLowerCase() : '',
            subregion: subregionFilter ? subregionFilter.value.toLowerCase() : '',
            pais: paisFilter ? paisFilter.value.toLowerCase() : ''
        };

        let visibleCount = 0;
        
        tableRows.forEach(row => {
            if (!row.cells || row.cells.length < 7) return;
            
            try {
                // Extraer datos de la fila de manera más robusta
                const nameCell = row.cells[0].querySelector('div:last-child');
                const industriaCell = row.cells[1];
                const estadoCell = row.cells[2].querySelector('.badge');
                const regionCell = row.cells[3];
                const subregionCell = row.cells[4];
                const paisCell = row.cells[5];
                
                const rowData = {
                    nombre: nameCell ? nameCell.textContent.trim().toLowerCase() : '',
                    industria: industriaCell ? industriaCell.textContent.trim().toLowerCase() : '',
                    estado: estadoCell ? estadoCell.textContent.trim().toLowerCase() : '',
                    region: regionCell ? regionCell.textContent.trim().toLowerCase() : '',
                    subregion: subregionCell ? subregionCell.textContent.trim().toLowerCase() : '',
                    pais: paisCell ? paisCell.textContent.trim().toLowerCase() : ''
                };

                let showRow = true;

                // Aplicar cada filtro
                Object.keys(filters).forEach(key => {
                    if (filters[key] && !rowData[key].includes(filters[key])) {
                        showRow = false;
                    }
                });

                // Mostrar u ocultar la fila
                if (showRow) {
                    row.style.display = '';
                    visibleCount++;
                } else {
                    row.style.display = 'none';
                }
            } catch (error) {
                console.warn('Error processing row:', error);
                // En caso de error, mostrar la fila
                row.style.display = '';
                visibleCount++;
            }
        });

        console.log(`Mostrando ${visibleCount} de ${tableRows.length} aliados`);
    }
}

// Función para inicializar eventos del modal de gestión de datos
function initializeDataModalEvents() {
    const dataModal = document.getElementById('dataManagementModal');
    if (!dataModal) {
        console.error('Modal dataManagementModal no encontrado');
        return;
    }
    
    console.log('Inicializando eventos del modal de gestión de datos');
    
    // Configurar botones que abren el modal
    const openDataModalButtons = document.querySelectorAll('[data-bs-toggle="modal"][data-bs-target="#dataManagementModal"]');
    openDataModalButtons.forEach(button => {
        button.addEventListener('click', function(e) {
            e.preventDefault();
            showModal('dataManagementModal');
        });
    });
    
    // Configurar botones que cierran el modal
    const closeDataModalButtons = dataModal.querySelectorAll('[data-bs-dismiss="modal"]');
    closeDataModalButtons.forEach(button => {
        button.addEventListener('click', function(e) {
            e.preventDefault();
            hideModal('dataManagementModal');
        });
    });
    
    // Cerrar modal al hacer click en el backdrop
    dataModal.addEventListener('click', function(e) {
        if (e.target === dataModal) {
            hideModal('dataManagementModal');
        }
    });
    
    // Inicializar opciones de datos
    const dataOptions = dataModal.querySelectorAll('.data-option');
    dataOptions.forEach((option, index) => {
        option.addEventListener('click', function(e) {
            e.preventDefault();
            const type = index === 0 ? 'import' : 'export';
            console.log('Seleccionando tipo de operación:', type);
            selectDataType(type, this);
        });
    });
}

// Función para seleccionar tipo de operación de datos
function selectDataType(type, element) {
    console.log('Seleccionando tipo de operación:', type);
    selectedDataType = type;

    // Remover clase active de todas las opciones
    document.querySelectorAll('.data-option').forEach(option => {
        option.classList.remove('active');
    });

    // Agregar clase active a la opción seleccionada
    if (element) {
        element.classList.add('active');
    }

    // Obtener elementos del DOM
    const importForm = document.getElementById('importForm');
    const exportForm = document.getElementById('exportForm');

    // Ocultar todos los formularios
    if (importForm) importForm.style.display = 'none';
    if (exportForm) exportForm.style.display = 'none';

    // Mostrar el formulario correspondiente
    if (type === 'import' && importForm) {
        importForm.style.display = 'block';
        console.log('Mostrando formulario de importación');
    } else if (type === 'export' && exportForm) {
        exportForm.style.display = 'block';
        console.log('Mostrando formulario de exportación');
    }
}

// Función para ejecutar acción de datos
function executeDataAction() {
    console.log('Ejecutando acción de datos, tipo seleccionado:', selectedDataType);
    
    if (!selectedDataType) {
        alert('Por favor selecciona un tipo de operación');
        return;
    }

    if (selectedDataType === 'import') {
        executeImport();
    } else if (selectedDataType === 'export') {
        executeExport();
    }
}

// Función para ejecutar importación
function executeImport() {
    const fileInput = document.getElementById('importFile');
    const overwriteData = document.getElementById('overwriteData');
    
    if (!fileInput || !fileInput.files || fileInput.files.length === 0) {
        alert('Por favor selecciona un archivo para importar');
        return;
    }
    
    const file = fileInput.files[0];
    const allowedExtensions = ['.xlsx', '.xls', '.csv'];
    const fileExtension = '.' + file.name.split('.').pop().toLowerCase();
    
    if (!allowedExtensions.includes(fileExtension)) {
        alert('Formato de archivo no soportado. Use Excel (.xlsx, .xls) o CSV (.csv)');
        return;
    }
    
    console.log('Importando archivo:', file.name);
    console.log('Sobrescribir datos:', overwriteData ? overwriteData.checked : false);
    
    // Simular importación
    alert(`Archivo "${file.name}" importado exitosamente.\n${Math.floor(Math.random() * 50) + 10} aliados procesados.`);
    
    // Cerrar modal
    hideModal('dataManagementModal');
    
    // Recargar página para mostrar nuevos datos
    setTimeout(() => {
        location.reload();
    }, 1000);
}

// Función para ejecutar exportación
function executeExport() {
    const exportFormat = document.getElementById('exportFormat');
    const includeAll = document.getElementById('includeAll');
    const includeFiltered = document.getElementById('includeFiltered');
    
    // Obtener columnas seleccionadas
    const selectedColumns = [];
    const columnCheckboxes = {
        'colNombre': 'Nombre',
        'colIndustria': 'Industria',
        'colEstado': 'Estado',
        'colRegion': 'Región',
        'colSubregion': 'Subregión',
        'colPais': 'País',
        'colSede': 'Sede',
        'colContacto': 'Contacto'
    };
    
    Object.keys(columnCheckboxes).forEach(id => {
        const checkbox = document.getElementById(id);
        if (checkbox && checkbox.checked) {
            selectedColumns.push(columnCheckboxes[id]);
        }
    });
    
    if (selectedColumns.length === 0) {
        alert('Por favor selecciona al menos una columna para exportar');
        return;
    }
    
    const format = exportFormat ? exportFormat.value : 'xlsx';
    const dataScope = includeAll && includeAll.checked ? 'todos' : 'filtrados';
    
    console.log('Exportando datos en formato:', format);
    console.log('Alcance de datos:', dataScope);
    console.log('Columnas seleccionadas:', selectedColumns);
    
    // Simular exportación
    const fileName = `aliados_${new Date().toISOString().split('T')[0]}.${format}`;
    alert(`Archivo "${fileName}" generado exitosamente.\nColumnas incluidas: ${selectedColumns.join(', ')}`);
    
    // Cerrar modal
    hideModal('dataManagementModal');
    
    // Simular descarga
    console.log('Simulando descarga del archivo:', fileName);
}
</script>

{% endblock %}